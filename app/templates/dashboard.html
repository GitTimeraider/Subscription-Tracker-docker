{% extends "base.html" %}

{% block title %}Dashboard - Subscription Tracker{% endblock %}

{% block content %}
{% if rate_provider %}
<div class="alert alert-info py-2 mb-3">
    <i class="fas fa-globe me-1"></i>
    Provider in use: <strong>{{ rate_provider }}</strong>
    {% if requested_provider and requested_provider != rate_provider %}
        <span class="ms-2 text-warning"><i class="fas fa-exclamation-triangle me-1"></i>Requested {{ requested_provider }} but using {{ rate_provider }} (fallback / cache).</span>
    {% endif %}
    {% if rate_provider == 'fallback' %}
        <span class="ms-2 text-warning"><i class="fas fa-exclamation-triangle me-1"></i>Using static fallback rates – refresh later.</span>
    {% endif %}
</div>
{% endif %}
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card stats-card">
            <div class="card-body text-center">
                <h3>{{ currency_symbol }}{{ "%.2f"|format(total_monthly) }}</h3>
                <p class="mb-0">Monthly Total ({{ user_currency }})</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card stats-card">
            <div class="card-body text-center">
                <h3>{{ currency_symbol }}{{ "%.2f"|format(total_yearly) }}</h3>
                <p class="mb-0">Yearly Total ({{ user_currency }})</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card stats-card">
            <div class="card-body text-center">
                <h3>{{ subscriptions|length }}</h3>
                <p class="mb-0">Total Subscriptions</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card stats-card">
            <div class="card-body text-center">
                <h3>{{ expiring_soon|length }}</h3>
                <p class="mb-0">Expiring Soon</p>
            </div>
        </div>
    </div>
</div>

{% if expiring_soon %}
<div class="alert alert-warning" role="alert">
    <h4 class="alert-heading"><i class="fas fa-exclamation-triangle me-2"></i>Subscriptions Expiring Soon!</h4>
    <p>You have {{ expiring_soon|length }} subscription(s) expiring within your notification window:</p>
    <hr>
    {% for sub in expiring_soon %}
    <div class="d-flex justify-content-between align-items-center mb-2">
        <span><strong>{{ sub.name }}</strong> ({{ sub.company }}) - Expires in {{ sub.days_until_expiry() }} day(s)</span>
        <a href="{{ url_for('main.edit_subscription', id=sub.id) }}" class="btn btn-sm btn-outline-warning">
            <i class="fas fa-edit me-1"></i>Edit
        </a>
    </div>
    {% endfor %}
</div>
{% endif %}

<div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
        <div>
            <h2 class="mb-0"><i class="fas fa-list me-2"></i>Your Subscriptions</h2>
            <small class="text-muted">Click column headers to sort • Use controls above to filter and sort</small>
        </div>
        <div class="d-flex gap-2">
            <a href="{{ url_for('main.add_subscription') }}" class="btn btn-light">
                <i class="fas fa-plus me-1"></i>Add Subscription
            </a>
        </div>
    </div>
    <div class="card-body">
        <!-- Filters and Sorting -->
        <div class="row mb-3">
            <div class="col-md-3">
                <label for="categoryFilter" class="form-label">Filter by Category:</label>
                <select id="categoryFilter" class="form-select" onchange="applyFilters()">
                    <option value="all" {{ 'selected' if current_category == 'all' else '' }}>All Categories</option>
                    {% for category in categories %}
                    <option value="{{ category }}" {{ 'selected' if current_category == category else '' }}>
                        {{ category|replace('_', ' ')|title }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-3">
                <label for="statusFilter" class="form-label">Filter by Status:</label>
                <select id="statusFilter" class="form-select" onchange="applyFilters()">
                    <option value="all" {{ 'selected' if current_status == 'all' else '' }}>All Subscriptions</option>
                    <option value="active" {{ 'selected' if current_status == 'active' else '' }}>Active Only</option>
                    <option value="inactive" {{ 'selected' if current_status == 'inactive' else '' }}>Inactive Only</option>
                    <option value="expiring" {{ 'selected' if current_status == 'expiring' else '' }}>Expiring Soon</option>
                </select>
            </div>
            <div class="col-md-3">
                <label for="sortBy" class="form-label">Sort by:</label>
                <select id="sortBy" class="form-select" onchange="applySorting()">
                    <option value="name" {{ 'selected' if current_sort == 'name' else '' }}>Name (A-Z)</option>
                    <option value="company" {{ 'selected' if current_sort == 'company' else '' }}>Company (A-Z)</option>
                    <option value="category" {{ 'selected' if current_sort == 'category' else '' }}>Category</option>
                    <option value="cost" {{ 'selected' if current_sort == 'cost' else '' }}>Original Cost</option>
                    <option value="monthly_cost" {{ 'selected' if current_sort == 'monthly_cost' else '' }}>Monthly Cost</option>
                    <option value="start_date" {{ 'selected' if current_sort == 'start_date' else '' }}>Start Date</option>
                    <option value="end_date" {{ 'selected' if current_sort == 'end_date' else '' }}>End Date</option>
                </select>
            </div>
            <div class="col-md-3">
                <label for="sortOrder" class="form-label">Order:</label>
                <div class="d-flex gap-2">
                    <select id="sortOrder" class="form-select" onchange="applySorting()">
                        <option value="asc" {{ 'selected' if current_order == 'asc' else '' }}>Ascending</option>
                        <option value="desc" {{ 'selected' if current_order == 'desc' else '' }}>Descending</option>
                    </select>
                    <button type="button" class="btn btn-outline-secondary" onclick="clearFilters()" title="Clear all filters and sorting">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
        </div>

        {% if subscriptions %}
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th class="sortable-header" data-sort="name">
                            <i class="fas fa-tag me-1"></i>Name
                            {% if current_sort == 'name' %}
                                <i class="fas fa-sort-{{ 'up' if current_order == 'asc' else 'down' }} ms-1 text-primary"></i>
                            {% else %}
                                <i class="fas fa-sort ms-1 text-muted"></i>
                            {% endif %}
                        </th>
                        <th class="sortable-header" data-sort="company">
                            <i class="fas fa-building me-1"></i>Company
                            {% if current_sort == 'company' %}
                                <i class="fas fa-sort-{{ 'up' if current_order == 'asc' else 'down' }} ms-1 text-primary"></i>
                            {% else %}
                                <i class="fas fa-sort ms-1 text-muted"></i>
                            {% endif %}
                        </th>
                        <th class="sortable-header" data-sort="category">
                            <i class="fas fa-folder me-1"></i>Category
                            {% if current_sort == 'category' %}
                                <i class="fas fa-sort-{{ 'up' if current_order == 'asc' else 'down' }} ms-1 text-primary"></i>
                            {% else %}
                                <i class="fas fa-sort ms-1 text-muted"></i>
                            {% endif %}
                        </th>
                        <th class="sortable-header" data-sort="cost">
                            <i class="fas fa-dollar-sign me-1"></i>Cost
                            {% if current_sort == 'cost' %}
                                <i class="fas fa-sort-{{ 'up' if current_order == 'asc' else 'down' }} ms-1 text-primary"></i>
                            {% else %}
                                <i class="fas fa-sort ms-1 text-muted"></i>
                            {% endif %}
                        </th>
                        <th><i class="fas fa-credit-card me-1"></i>Payment</th>
                        <th><i class="fas fa-calendar me-1"></i>Cycle</th>
                        <th class="sortable-header" data-sort="monthly_cost">
                            <i class="fas fa-calculator me-1"></i>Monthly
                            {% if current_sort == 'monthly_cost' %}
                                <i class="fas fa-sort-{{ 'up' if current_order == 'asc' else 'down' }} ms-1 text-primary"></i>
                            {% else %}
                                <i class="fas fa-sort ms-1 text-muted"></i>
                            {% endif %}
                        </th>
                        <th class="sortable-header" data-sort="start_date">
                            <i class="fas fa-play me-1"></i>Start
                            {% if current_sort == 'start_date' %}
                                <i class="fas fa-sort-{{ 'up' if current_order == 'asc' else 'down' }} ms-1 text-primary"></i>
                            {% else %}
                                <i class="fas fa-sort ms-1 text-muted"></i>
                            {% endif %}
                        </th>
                        <th class="sortable-header" data-sort="end_date">
                            <i class="fas fa-stop me-1"></i>End
                            {% if current_sort == 'end_date' %}
                                <i class="fas fa-sort-{{ 'up' if current_order == 'asc' else 'down' }} ms-1 text-primary"></i>
                            {% else %}
                                <i class="fas fa-sort ms-1 text-muted"></i>
                            {% endif %}
                        </th>
                        <th><i class="fas fa-toggle-on me-1"></i>Status</th>
                        <th><i class="fas fa-cogs me-1"></i>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for sub in subscriptions %}
                    <tr class="{{ 'table-warning' if sub.is_expiring_soon(7) else '' }}">
                        <td>
                            <strong>{{ sub.name }}</strong>
                            {% if sub.notes %}
                                <i class="fas fa-sticky-note text-muted ms-1" title="{{ sub.notes }}" data-bs-toggle="tooltip"></i>
                            {% endif %}
                        </td>
                        <td>{{ sub.company }}</td>
                        <td>
                            {% if sub.category %}
                                <span class="badge bg-secondary">{{ sub.category|replace('_', ' ')|title }}</span>
                            {% else %}
                                <span class="text-muted">N/A</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if sub.currency %}
                                {% if sub.currency == 'USD' %}${% elif sub.currency == 'EUR' %}€{% elif sub.currency == 'GBP' %}£{% elif sub.currency == 'JPY' %}¥{% else %}{{ sub.currency }} {% endif %}{{ "%.2f"|format(sub.cost) }}
                                {% if sub.currency != user_currency %}
                                    <small class="text-muted">({{ sub.currency }})</small>
                                {% endif %}
                            {% else %}
                                ${{ "%.2f"|format(sub.cost) }}
                            {% endif %}
                        </td>
                        <td>
                            {% if sub.payment_method %}
                                <small class="text-primary">{{ sub.payment_method.name }}</small>
                                {% if sub.payment_method.last_four %}
                                    <br><small class="text-muted">•••• {{ sub.payment_method.last_four }}</small>
                                {% endif %}
                            {% else %}
                                <small class="text-muted">Not set</small>
                            {% endif %}
                        </td>
                        <td>
                            {% if sub.billing_cycle == 'custom' %}
                                {% if sub.custom_period_value and sub.custom_period_type %}
                                    <span class="badge bg-info">Every {{ sub.custom_period_value }} {{ sub.custom_period_type }}</span>
                                {% else %}
                                    <span class="badge bg-warning">Custom (undefined)</span>
                                {% endif %}
                            {% else %}
                                <span class="badge bg-primary">{{ sub.billing_cycle|title }}</span>
                            {% endif %}
                        </td>
                        <td>
                            <strong>{{ currency_symbol }}{{ "%.2f"|format(sub.get_monthly_cost_in_currency(user_currency)) }}</strong>
                        </td>
                        <td>{{ sub.start_date|user_date }}</td>
                        <td>
                            {% if sub.end_date %}
                                {{ sub.end_date|user_date }}
                                {% set days_left = sub.days_until_expiry() %}
                                {% if days_left is not none %}
                                    <br>
                                    {% if days_left <= 3 %}
                                        <small class="text-danger">({{ days_left }} days left)</small>
                                    {% elif days_left <= 7 %}
                                        <small class="text-warning">({{ days_left }} days left)</small>
                                    {% else %}
                                        <small class="text-muted">({{ days_left }} days left)</small>
                                    {% endif %}
                                {% endif %}
                            {% else %}
                                <span class="badge bg-success">Infinite</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if sub.is_active %}
                                <span class="badge bg-success">Active</span>
                            {% else %}
                                <span class="badge bg-secondary">Inactive</span>
                            {% endif %}
                        </td>
                        <td>
                            <div class="btn-group" role="group">
                                <a href="{{ url_for('main.edit_subscription', id=sub.id) }}" 
                                   class="btn btn-sm btn-outline-primary" title="Edit">
                                    <i class="fas fa-edit"></i>
                                </a>
                                <a href="{{ url_for('main.toggle_subscription', id=sub.id) }}" 
                                   class="btn btn-sm btn-outline-{{ 'secondary' if sub.is_active else 'success' }}" 
                                   title="{{ 'Deactivate' if sub.is_active else 'Activate' }}">
                                    <i class="fas fa-toggle-{{ 'off' if sub.is_active else 'on' }}"></i>
                                </a>
                                <a href="{{ url_for('main.delete_subscription', id=sub.id) }}" 
                                   class="btn btn-sm btn-outline-danger" 
                                   title="Delete"
                                   onclick="return confirm('Are you sure you want to delete this subscription?')">
                                    <i class="fas fa-trash"></i>
                                </a>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="text-center py-5">
            <i class="fas fa-credit-card fa-3x text-muted mb-3"></i>
            <h4>No subscriptions found</h4>
            <p class="text-muted">Get started by adding your first subscription!</p>
            <a href="{{ url_for('main.add_subscription') }}" class="btn btn-primary">
                <i class="fas fa-plus me-1"></i>Add Your First Subscription
            </a>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Initialize tooltips
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl)
    })

    function applyFilters() {
        const category = document.getElementById('categoryFilter').value;
        const status = document.getElementById('statusFilter').value;
        
        const url = new URL(window.location);
        url.searchParams.set('category', category);
        url.searchParams.set('status', status);
        // Preserve current sorting
        const currentSort = '{{ current_sort }}';
        const currentOrder = '{{ current_order }}';
        if (currentSort) url.searchParams.set('sort', currentSort);
        if (currentOrder) url.searchParams.set('order', currentOrder);
        
        window.location.href = url.toString();
    }

    function applySorting() {
        const sortBy = document.getElementById('sortBy').value;
        const sortOrder = document.getElementById('sortOrder').value;
        
        const url = new URL(window.location);
        url.searchParams.set('sort', sortBy);
        url.searchParams.set('order', sortOrder);
        // Preserve current filters
        const currentCategory = '{{ current_category }}';
        const currentStatus = '{{ current_status }}';
        if (currentCategory) url.searchParams.set('category', currentCategory);
        if (currentStatus) url.searchParams.set('status', currentStatus);
        
        window.location.href = url.toString();
    }

    function clearFilters() {
        window.location.href = '{{ url_for("main.dashboard") }}';
    }
    
    // Add click handlers for sortable headers
    document.addEventListener('DOMContentLoaded', function() {
        const sortableHeaders = document.querySelectorAll('.sortable-header');
        sortableHeaders.forEach(header => {
            header.style.cursor = 'pointer';
            header.addEventListener('click', function() {
                const sortField = this.dataset.sort;
                const currentSort = '{{ current_sort }}';
                const currentOrder = '{{ current_order }}';
                
                // If clicking the same column, toggle order; otherwise, default to ascending
                let newOrder = 'asc';
                if (currentSort === sortField && currentOrder === 'asc') {
                    newOrder = 'desc';
                }
                
                const url = new URL(window.location);
                url.searchParams.set('sort', sortField);
                url.searchParams.set('order', newOrder);
                // Preserve current filters
                const currentCategory = '{{ current_category }}';
                const currentStatus = '{{ current_status }}';
                if (currentCategory) url.searchParams.set('category', currentCategory);
                if (currentStatus) url.searchParams.set('status', currentStatus);
                
                window.location.href = url.toString();
            });
        });
    });
    
    // Add hover effect for sortable headers
    const style = document.createElement('style');
    style.textContent = `
        .sortable-header:hover {
            background-color: rgba(0, 123, 255, 0.1);
        }
        .sortable-header:hover .fa-sort {
            color: #007bff !important;
        }
    `;
    document.head.appendChild(style);
</script>
{% endblock %}
